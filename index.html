<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ETPS Full Planner</title>
  <style>
    body { font-family: Arial; margin: 0; }
    .tabs { display: flex; background: #333; color: white; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; }
    .tab.active { background: #666; }
    .grid-container { overflow-x: auto; padding: 10px; }
    .grid { display: grid; grid-template-columns: 80px repeat(6, 160px); grid-auto-rows: 40px; }
    .cell, .header { border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; position: relative; }
    .header { background: #f0f0f0; font-weight: bold; }
    .tile {
      background: #cce5ff;
      border: 2px solid #004085;
      position: absolute;
      width: 95%;
      height: 85%;
      top: 2px;
      left: 2px;
      box-sizing: border-box;
      padding: 4px;
      font-size: 12px;
    }
    .captain { color: red; font-weight: bold; }
    .popup, .overlay {
      display: none; position: fixed;
    }
    .overlay {
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 5;
    }
    .popup {
      top: 20%; left: 30%; width: 40%; background: white;
      border: 2px solid #444; padding: 20px; z-index: 10;
    }
  </style>
</head>
<body>
<div class="tabs">
  <div class="tab active">Monday</div>
  <div class="tab">Tuesday</div>
  <div class="tab">Wednesday</div>
  <div class="tab">Thursday</div>
  <div class="tab">Friday</div>
</div>

<div class="grid-container">
  <div class="grid" id="grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div class="popup" id="popup">
  <h3>Edit Tile</h3>
  <form id="popupForm" onsubmit="savePopup(); return false;">
    <input type="hidden" id="popupKey" />
    <p>Take Off: <input type="text" id="popupTakeoff" placeholder="09:00" /></p>
    <p>Landing: <input type="text" id="popupLanding" placeholder="10:00" /></p>
    <p>Captain: <input type="text" id="popupCaptain" /></p>
    <p>Other Persons: <input type="text" id="popupOthers" /></p>
    <p>Fuel State: <input type="text" id="popupFuel" /></p>
    <button type="submit">Save</button>
    <button type="button" onclick="closePopup()">Cancel</button>
  </form>
</div>

<script>
// --- Data and helpers ---
const times = [];
for (let h = 9; h <= 17; h++) {
  for (let m = 0; m < 60; m += 15) {
    times.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
  }
}
const rooms = ["XX101", "XX102", "SPARE", "PREFLIGHT", "LUNCH", "XX201"];
window.tileData = window.tileData || {};
// Example: prepopulate one tile if not present
if (!tileData["XX101_09:00"]) {
  tileData["XX101_09:00"] = {
    takeoff: "09:00",
    landing: "10:00",
    captain: "PE",
    others: "HOL",
    fuel: "300"
  };
}

function timeToIndex(time) {
  return times.indexOf(time);
}
function indexToTime(idx) {
  return times[idx];
}

// --- Grid rendering ---
function renderGrid() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  // Set grid columns
  let cols = '80px';
  for (let i = 0; i < times.length; i++) cols += ' 25px';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = cols;
  // Header row
  const headerRoom = document.createElement('div');
  headerRoom.className = 'header';
  headerRoom.textContent = 'Room/Block';
  grid.appendChild(headerRoom);
  for (let t = 0; t < times.length; t++) {
    const th = document.createElement('div');
    th.className = 'header';
    th.textContent = times[t];
    grid.appendChild(th);
  }
  // Rows
  for (let r = 0; r < rooms.length; r++) {
    // Room label
    const roomHeader = document.createElement('div');
    roomHeader.className = 'header';
    roomHeader.textContent = rooms[r];
    grid.appendChild(roomHeader);
    // Prepare a row of empty cells
    const rowCells = Array(times.length).fill(null);
    // Find all tiles for this room
    const tiles = [];
    for (const key in tileData) {
      if (key.startsWith(rooms[r] + '_')) {
        const tile = tileData[key];
        const startIdx = timeToIndex(tile.takeoff);
        const endIdx = timeToIndex(tile.landing);
        if (startIdx !== -1 && endIdx !== -1 && endIdx > startIdx) {
          tiles.push({ start: startIdx, end: endIdx, tile, key });
        }
      }
    }
    // Sort tiles by start time
    tiles.sort((a, b) => a.start - b.start);
    // Place tiles and empty cells
    let t = 0;
    while (t < times.length) {
      // Check if a tile starts here
      const tileObj = tiles.find(tile => tile.start === t);
      if (tileObj) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.style.position = 'relative';
        cell.style.gridColumn = `span ${tileObj.end - tileObj.start}`;
        cell.ondblclick = () => openPopup(tileObj.key);
        const tileDiv = document.createElement('div');
        tileDiv.className = 'tile';
        tileDiv.innerHTML =
          `<div class="captain">${tileObj.tile.captain}</div>${tileObj.tile.others}` +
          `<div style="position:absolute;top:2px;right:2px;">${tileObj.tile.fuel}</div>` +
          `<div style="position:absolute;bottom:2px;right:2px;">${tileObj.tile.takeoff}-${tileObj.tile.landing}</div>`;
        cell.appendChild(tileDiv);
        grid.appendChild(cell);
        t += (tileObj.end - tileObj.start);
      } else {
        // Empty cell
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.ondblclick = () => openPopup(rooms[r] + '_' + times[t]);
        grid.appendChild(cell);
        t++;
      }
    }
  }
}

// --- Popup logic ---
function openPopup(key) {
  const data = window.tileData[key] || { takeoff: '', landing: '', captain: '', others: '', fuel: '' };
  document.getElementById("popupKey").value = key;
  document.getElementById("popupTakeoff").value = data.takeoff;
  document.getElementById("popupLanding").value = data.landing;
  document.getElementById("popupCaptain").value = data.captain;
  document.getElementById("popupOthers").value = data.others;
  document.getElementById("popupFuel").value = data.fuel;
  document.getElementById("popup").style.display = "block";
  document.getElementById("overlay").style.display = "block";
}
function closePopup() {
  document.getElementById("popup").style.display = "none";
  document.getElementById("overlay").style.display = "none";
}
function savePopup() {
  const key = document.getElementById("popupKey").value;
  window.tileData[key] = {
    takeoff: document.getElementById("popupTakeoff").value,
    landing: document.getElementById("popupLanding").value,
    captain: document.getElementById("popupCaptain").value,
    others: document.getElementById("popupOthers").value,
    fuel: document.getElementById("popupFuel").value
  };
  closePopup();
  renderGrid();
}
// Initial render
renderGrid();
</script>
</body>
</html>
