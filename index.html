<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ETPS Full Planner</title>
  <style>
    body { font-family: Arial; margin: 0; }
    .tabs { display: flex; background: #333; color: white; }
    .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; }
    .tab.active { background: #666; }
    .grid-container { overflow-x: auto; padding: 10px; }
    .grid { display: grid; grid-template-columns: 80px repeat(6, 160px); grid-auto-rows: 40px; }
    .cell, .header { border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; position: relative; }
    .header { background: #f0f0f0; font-weight: bold; }
    .tile {
      background: #cce5ff;
      border: 2px solid #004085;
      position: absolute;
      width: 95%;
      height: 85%;
      top: 2px;
      left: 2px;
      box-sizing: border-box;
      padding: 4px;
      font-size: 12px;
    }
    .captain { color: red; font-weight: bold; }
    .popup, .overlay {
      display: none; position: fixed;
    }
    .overlay {
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 5;
    }
    .popup {
      top: 20%; left: 30%; width: 40%; background: white;
      border: 2px solid #444; padding: 20px; z-index: 10;
    }
  </style>
</head>
<body>
<div class="tabs">
  <div class="tab active">Monday</div>
  <div class="tab">Tuesday</div>
  <div class="tab">Wednesday</div>
  <div class="tab">Thursday</div>
  <div class="tab">Friday</div>
</div>

<div class="grid-container">
  <div class="grid" id="grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div class="popup" id="popup">
  <h3>Edit Tile</h3>
  <form id="popupForm" onsubmit="savePopup(); return false;">
    <input type="hidden" id="popupKey" />
    <p>Take Off: <input type="text" id="popupTakeoff" placeholder="09:00" /></p>
    <p>Landing: <input type="text" id="popupLanding" placeholder="10:00" /></p>
    <p>Captain: <input type="text" id="popupCaptain" /></p>
    <p>Other Persons: <input type="text" id="popupOthers" /></p>
    <p>Fuel State: <input type="text" id="popupFuel" /></p>
    <p>FTI: <input type="text" id="popupFTI" /></p>
    <p>Notes: <textarea id="popupNotes" rows="2" style="width:100%"></textarea></p>
    <button type="submit">Save</button>
    <button type="button" onclick="closePopup()">Cancel</button>
    <button type="button" id="deleteBtn" onclick="deletePopup()" style="display:none;background:#c00;color:#fff;float:right;">Delete</button>
  </form>
</div>

<script>
// --- Data and helpers ---
const times = [];
for (let h = 9; h <= 17; h++) {
  for (let m = 0; m < 60; m += 15) {
    times.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
  }
}
const aircrafts = ["XX101", "XX102", "SPARE", "PREFLIGHT", "LUNCH", "XX201"];
let tiles = [];

function timeToIndex(time) {
  return times.indexOf(time);
}
function indexToTime(idx) {
  return times[idx];
}

// --- Grid rendering ---
function renderGrid() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  // Set grid columns
  let cols = '80px';
  for (let i = 0; i < times.length; i++) cols += ' 1fr';
  grid.style.display = 'grid';
  grid.style.gridTemplateColumns = cols;
  // Header row
  const headerAircraft = document.createElement('div');
  headerAircraft.className = 'header';
  headerAircraft.textContent = 'Aircraft';
  grid.appendChild(headerAircraft);
  for (let t = 0; t < times.length; t++) {
    const th = document.createElement('div');
    th.className = 'header';
    // Only show label for :00 times, otherwise no annotation at all
    if (times[t].endsWith(':00')) {
      th.textContent = times[t];
    }
    grid.appendChild(th);
  }
  // Rows
  for (let r = 0; r < aircrafts.length; r++) {
    // Aircraft label
    const aircraftHeader = document.createElement('div');
    aircraftHeader.className = 'header';
    aircraftHeader.textContent = aircrafts[r];
    grid.appendChild(aircraftHeader);
    // Find all tiles for this aircraft
    const rowTiles = tiles.filter(tile => tile.aircraft === aircrafts[r]);
    // Sort by takeoff time
    rowTiles.sort((a, b) => timeToIndex(a.takeoff) - timeToIndex(b.takeoff));
    let t = 0;
    while (t < times.length) {
      // Check if a tile starts here
      const tileObj = rowTiles.find(tile => timeToIndex(tile.takeoff) === t);
      if (tileObj) {
        const startIdx = timeToIndex(tileObj.takeoff);
        const endIdx = timeToIndex(tileObj.landing);
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.style.position = 'relative';
        cell.style.gridColumn = `span ${endIdx - startIdx}`;
        cell.ondblclick = () => openPopup(tileObj);
        const tileDiv = document.createElement('div');
        tileDiv.className = 'tile';
        tileDiv.innerHTML =
          `<div class="captain">${tileObj.captain || ''}</div>${tileObj.others || ''}` +
          `<div style="position:absolute;top:2px;right:2px;">${tileObj.fuel || ''}</div>` +
          `<div style="position:absolute;bottom:2px;right:2px;">${tileObj.takeoff || ''}-${tileObj.landing || ''}</div>` +
          `<div style="position:absolute;bottom:2px;left:2px;font-size:10px;">${tileObj.fti || ''}</div>`;
        cell.appendChild(tileDiv);
        grid.appendChild(cell);
        t += (endIdx - startIdx);
      } else {
        // Empty cell
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.ondblclick = () => openPopup({ aircraft: aircrafts[r], takeoff: times[t], landing: times[t], captain: '', others: '', fuel: '', fti: '', notes: '' });
        grid.appendChild(cell);
        t++;
      }
    }
  }
  // Remove addBtns if present
  const addBtns = document.getElementById('addBtns');
  if (addBtns && addBtns.parentNode) {
    addBtns.parentNode.removeChild(addBtns);
  }
}

// --- API helpers ---
const API_URL = 'REPLACE_WITH_YOUR_BACKEND_URL';
async function fetchTiles() {
  const res = await fetch(`${API_URL}/tiles`);
  tiles = await res.json();
  renderGrid();
}
async function saveTile(tile) {
  if (tile.id) {
    // Update
    await fetch(`${API_URL}/tiles/${tile.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(tile)
    });
  } else {
    // Create
    await fetch(`${API_URL}/tiles`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(tile)
    });
  }
  fetchTiles();
}
async function deleteTile(id) {
  await fetch(`${API_URL}/tiles/${id}`, { method: 'DELETE' });
  fetchTiles();
}

// --- Popup logic ---
let currentTile = null;
function openPopup(tile) {
  currentTile = tile;
  document.getElementById("popupKey").value = tile.id || '';
  document.getElementById("popupTakeoff").value = tile.takeoff || '';
  document.getElementById("popupLanding").value = tile.landing || '';
  document.getElementById("popupCaptain").value = tile.captain || '';
  document.getElementById("popupOthers").value = tile.others || '';
  document.getElementById("popupFuel").value = tile.fuel || '';
  document.getElementById("popupFTI").value = tile.fti || '';
  document.getElementById("popupNotes").value = tile.notes || '';
  document.getElementById("popup").style.display = "block";
  document.getElementById("overlay").style.display = "block";
  document.getElementById("deleteBtn").style.display = tile.id ? 'inline-block' : 'none';
}
function closePopup() {
  document.getElementById("popup").style.display = "none";
  document.getElementById("overlay").style.display = "none";
}
function savePopup() {
  const tile = {
    id: document.getElementById("popupKey").value || undefined,
    aircraft: currentTile.aircraft,
    takeoff: document.getElementById("popupTakeoff").value,
    landing: document.getElementById("popupLanding").value,
    captain: document.getElementById("popupCaptain").value,
    others: document.getElementById("popupOthers").value,
    fuel: document.getElementById("popupFuel").value,
    fti: document.getElementById("popupFTI").value,
    notes: document.getElementById("popupNotes").value
  };
  saveTile(tile);
  closePopup();
}
function deletePopup() {
  if (currentTile && currentTile.id) {
    deleteTile(currentTile.id);
    closePopup();
  }
}
// Initial fetch
fetchTiles();
</script>
</body>
</html>
